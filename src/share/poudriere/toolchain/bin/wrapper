#!/bin/sh

if [ -z "${CHERIBSD_VERSION}" ]; then
	CHERIBSD_VERSION=$(awk '/^#define[[:space:]]+__CheriBSD_version/{print $3}' /usr/include/sys/param.h)
fi
if [ -z "${CHERIBSD_VERSION}" ]; then
	CHERIBSD_VERSION=0
fi

TOOLCHAIN_ROOT="/toolchain"
TOOLCHAIN_LOCALBASE="/toolchain/usr/local64"
TOOLCHAIN_LOCALBIN="${TOOLCHAIN_LOCALBASE}/bin"
TOOLCHAIN_LOCALLIB="${TOOLCHAIN_LOCALBASE}/lib"

LLVM_PREFIX="${TOOLCHAIN_LOCALBASE}/llvm-morello"
LLVM_BIN="${LLVM_PREFIX}/bin"
LLVM_LIB="${LLVM_PREFIX}/lib"

prog=$(basename "${0}")
if [ -z "${MACHINE_ARCH}" ]; then
	arch="$(sysctl -n hw.machine_arch)"
else
	arch="${MACHINE_ARCH}"
fi
arch_cflags=
arch_objdump_flags=
case "${arch}" in
aarch64)
	if [ "${CHERIBSD_VERSION}" -le 20220314 ]; then
		vararg_flags=""
	else
		vararg_flags="-Xclang -morello-vararg=new"
	fi
	arch_cflags="-march=morello ${vararg_flags}"
	arch_objdump_flags="--mattr=+morello"
	;;
aarch64c)
	if [ "${CHERIBSD_VERSION}" -le 20220314 ]; then
		tls_flags="-femulated-tls"
		vararg_flags=""
	elif [ "${CHERIBSD_VERSION}" -le 20220828 ]; then
		tls_flags=""
		vararg_flags="-Xclang -morello-vararg=new"
	else
		tls_flags=""
		vararg_flags="-Xclang -morello-vararg=new -Xclang -morello-bounded-memargs=caller-only"
	fi
	arch_cflags="-march=morello -mabi=purecap ${tls_flags} ${vararg_flags}"
	arch_objdump_flags="--mattr=+morello"
	;;
riscv64)
	arch_cflags="-march=rv64gcxcheri -mabi=lp64d -mno-relax"
	;;
riscv64c)
	arch_cflags="-march=rv64gcxcheri -mabi=l64pc128d -mno-relax"
	;;
*)
	echo "Unexpected arch: ${arch}." >&2
	exit 1
esac

#
# Use toolchain binaries and libraries.
#
export PATH="${TOOLCHAIN_LOCALBIN}:${PATH}"
case "${arch}" in
aarch64|riscv64)
	export LD_LIBRARY_PATH="${TOOLCHAIN_LOCALLIB}:${LLVM_LIB}:/usr/lib"
	;;
aarch64*c*|riscv64*c*)
	export LD_64_LIBRARY_PATH="${TOOLCHAIN_LOCALLIB}:${LLVM_LIB}:/usr/lib64"
	;;
esac
#
# Overwrite variables from make.conf so that subprocesses directly utilities.
#
export ADDR2LINE="${LLVM_BIN}/llvm-addr2line"
export AR="${LLVM_BIN}/llvm-ar"
export CC="${LLVM_BIN}/clang ${arch_cflags}"
export CPP="${LLVM_BIN}/clang-cpp ${arch_cflags}"
export CXX="${LLVM_BIN}/clang++ ${arch_cflags}"
export AS="${CC}"
export LD="${LLVM_BIN}/ld.lld"
export NM="${LLVM_BIN}/llvm-nm"
export OBJCOPY="${LLVM_BIN}/llvm-objcopy"
export OBJDUMP="${LLVM_BIN}/llvm-objdump ${arch_objdump_flags}"
export RANLIB="${LLVM_BIN}/llvm-ranlib"
export READELF="${LLVM_BIN}/llvm-readelf"
export SIZE="${LLVM_BIN}/llvm-size"
export STRINGS="${LLVM_BIN}/llvm-strings"
export STRIP="${LLVM_BIN}/llvm-strip"
export XCC="${CC}"
export XCPP="${CPP}"
export XCXX="${CXX}"

case "${prog}" in
addr2line)
	${ADDR2LINE} "${@}"
	;;
ar)
	${AR} "${@}"
	;;
as)
	${AS} "${@}"
	;;
c++|clang++)
	${CXX} "${@}"
	;;
cc|clang)
	${CC} "${@}"
	;;
cpp|clang-cpp)
	${CPP} "${@}"
	;;
ld)
	${LD} "${@}"
	;;
nm)
	${NM} "${@}"
	;;
objcopy)
	${OBJCOPY} "${@}"
	;;
objdump)
	${OBJDUMP} "${@}"
	;;
ranlib)
	${RANLIB} "${@}"
	;;
readelf)
	${READELF} "${@}"
	;;
size)
	${SIZE} "${@}"
	;;
strings)
	${STRINGS} "${@}"
	;;
strip)
	${STRIP} "${@}"
	;;
*)
	"${TOOLCHAIN_LOCALBIN}/${prog}" "${@}"
	;;
esac
